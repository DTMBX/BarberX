name: CI - Quality Checks

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read
  pull-requests: write  # For PR comments

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: Install Dependencies
        run: npm install --legacy-peer-deps
      
      - name: Run ESLint
        run: npm run lint:js
        continue-on-error: true  # 70 warnings currently
      
      - name: Run Stylelint
        run: npm run lint:css
      
      - name: Lint Summary
        run: |
          echo "✅ Linting completed"
          echo "Note: 70 ESLint warnings are known (tracked as tech debt)"

  build:
    name: Build Jekyll Site
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true
      
      - name: Build with Jekyll
        run: bundle exec jekyll build
        env:
          JEKYLL_ENV: production
      
      - name: Check Build Output
        run: |
          if [ ! -d "_site" ]; then
            echo "❌ Build failed: _site directory not found"
            exit 1
          fi
          echo "✅ Jekyll build successful"
          echo "Files generated: $(find _site -type f | wc -l)"

  test-tier1:
    name: Tier 1 — E2E Gate
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true
      
      - name: Install Dependencies
        run: npm install --legacy-peer-deps
      
      - name: Install Playwright Browsers
        run: npx playwright install chromium --with-deps
      
      - name: Build Jekyll Site
        run: bundle exec jekyll build
      
      - name: Start Jekyll Server
        run: |
          bundle exec jekyll serve --port 4000 &
          echo $! > jekyll.pid
          sleep 10
      
      - name: Verify Server Running
        run: |
          curl -f http://localhost:4000 || exit 1
          echo "✅ Jekyll server is running"
      
      - name: Run Tier 1 Playwright Tests (PR gate)
        run: npx playwright test tests/tier1/ tests/basic.spec.js --project=chromium-desktop --reporter=list
        env:
          BASE_URL: http://localhost:4000
      
      - name: Stop Jekyll Server
        if: always()
        run: |
          if [ -f jekyll.pid ]; then
            kill $(cat jekyll.pid) || true
          fi
      
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tier1-playwright-report
          path: playwright-report/
          retention-days: 30

  test-tier2:
    name: Tier 2 — Extended (non-blocking)
    runs-on: ubuntu-latest
    needs: [test-tier1]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true
      
      - name: Install Dependencies
        run: npm install --legacy-peer-deps
      
      - name: Install Playwright Browsers
        run: npx playwright install chromium --with-deps
      
      - name: Build Jekyll Site
        run: bundle exec jekyll build
      
      - name: Start Jekyll Server
        run: |
          bundle exec jekyll serve --port 4000 &
          echo $! > jekyll.pid
          sleep 10
      
      - name: Run Tier 2 Playwright Tests (extended)
        run: npx playwright test tests/tier2/ --project=chromium-desktop --reporter=list
        continue-on-error: true
        env:
          BASE_URL: http://localhost:4000
      
      - name: Stop Jekyll Server
        if: always()
        run: |
          if [ -f jekyll.pid ]; then
            kill $(cat jekyll.pid) || true
          fi
      
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tier2-playwright-report
          path: playwright-report/
          retention-days: 30

  security:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: Install Dependencies
        run: npm install --legacy-peer-deps
      
      - name: Run npm audit (production only)
        run: |
          npm audit --production --audit-level=moderate || true
          echo ""
          echo "✅ Security audit completed"
          echo "Target: 0 production vulnerabilities (currently: 0)"
      
      - name: Check for High/Critical Vulns
        run: |
          AUDIT_RESULT=$(npm audit --production --audit-level=high --json || true)
          HIGH_COUNT=$(echo $AUDIT_RESULT | jq -r '.metadata.vulnerabilities.high // 0')
          CRITICAL_COUNT=$(echo $AUDIT_RESULT | jq -r '.metadata.vulnerabilities.critical // 0')
          
          if [ "$CRITICAL_COUNT" -gt 0 ]; then
            echo "❌ CRITICAL: Found $CRITICAL_COUNT critical vulnerabilities"
            exit 1
          fi
          
          if [ "$HIGH_COUNT" -gt 0 ]; then
            echo "⚠️ WARNING: Found $HIGH_COUNT high severity vulnerabilities"
          fi
          
          echo "✅ No critical vulnerabilities found"

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint, build, test-tier1, test-tier2, security]
    if: always()
    
    steps:
      - name: Check Results
        run: |
          echo "=== CI Summary ==="
          echo "Lint:       ${{ needs.lint.result }}"
          echo "Build:      ${{ needs.build.result }}"
          echo "Tier 1 E2E: ${{ needs.test-tier1.result }}"
          echo "Tier 2 E2E: ${{ needs.test-tier2.result }}"
          echo "Security:   ${{ needs.security.result }}"
          
          # Hard gates: build, Tier 1, security
          if [ "${{ needs.build.result }}" != "success" ]; then
            echo "" && echo "❌ CI FAILED: Build failed" && exit 1
          fi
          if [ "${{ needs.test-tier1.result }}" != "success" ]; then
            echo "" && echo "❌ CI FAILED: Tier 1 E2E tests failed" && exit 1
          fi
          if [ "${{ needs.security.result }}" != "success" ]; then
            echo "" && echo "❌ CI FAILED: Security audit failed" && exit 1
          fi
          
          echo ""
          echo "✅ CI PASSED: All critical checks successful"
